---
layout: post
title: 第十一章操作系统笔记
tags: [Learning]
---
# 第十一章 输入输出与磁盘调度
- I/O设备
- I/O功能的组织
- 操作系统的I/O设计
- I/O缓冲
- 磁盘调度
- 磁盘高速缓存
- 主流操作系统的I/O


# I/O的特点
- I/O是系统性能的瓶颈
- 种类繁多、结构各异、速度差异大
- 理解操作系统的工作过程与结构的关键：理解I/O的工作过程与结构
- 与操作系统的其他功能联系密切

## I/O设备
- 人可读的（打印机、显示器。。。）
- 机器可读（磁盘驱动器，固态硬盘、传感器...）
- 通信（数字线路驱动器、调制解调器）

### I/O设备的差异
- 传输速率的差异
- 应用程序
- 控制复杂性
- 传送单位
- 数据表示
- 错误条件
### 设备组成
- I/O设备一般由机械和电子两部分组成
	- 机械：设备本身
	- 电子部分：设备控制器/适配器，插入计算机接口中。
- OS与控制器（接口）打交道，而不是设备本身

## I/O功能的组织
- 控制设备和内存/CPU之间数据传送的方式
	- 程序控制
	- 中断驱动方式
	- DMA：直接内存访问
		- DMA模块控制内存和I/O

### I/O传送控制方式的发展过程
1. CPU直接控制外围设备
2. 引入了控制器或I/O模块，使用程序控制方式
3. 中断控制方式
4. I/O模块通过DMA直接控制内存
5. I/O模块有独立的处理器（专门的指令集）（I/O通道）
6. I/O模块进一步发展成专用I/O计算机

### 中断
中断过程：
- 操作系统将I/O命令写入控制器寄存器
- 控制器从磁盘驱动器串行地一位一位地读一个快，直到将整块信息放入控制器的内部缓冲区中
- 控制器做和校验计算，核实错误，控制器产生一个中断
- CPU响应中断，控制给操作系统
- 操作系统重复地从控制器缓冲区一次一个字节或者一个字地读这个磁盘块的信息，并将其送入内存

## DMA
- CPU提供被读取块磁盘地址，目标存储地址，要读取的字节数
- 控制器将整块数据读进缓冲区，并进行核准校验
- 控制器按照指定存储器地址，把指定字节数数据送入主存
- 完成后控制器引发中断，通知操作系统

### DMA与中断的比较

### DMA的周期窃取技术
- 指令周期被挂起
- CPU暂停一个总线周期，但并不是中断（不用保存上下文）

### DMA的配置方式
1. 单总线，分离DMA
	- 所有I/O模块共享一个系统总线
	- DMA模块代理处理器，使用可编程I/O
	- 开销小，低效
	- 一个字节的传送需要两个总线周期（传送请求+传送）
2. 单总线，I/O集成DMA
	- 可扩展性差
	- DMA模块接口多样
3. I/O总线
	- 另起一I/O总线，用于连接DMA与所有I/O设备
	- 不会干扰处理器和内存之间的数据交换

## 操作系统设计问题
1. I/O机制的设计目标
	- 效率
	- 通用性
2. 逻辑结构：层次结构、模块化
3. I/O缓冲
4. 磁盘调度

## I/O软件设计目标
- 效率
	- 提高效率技术：I/O缓冲、磁盘调度、磁盘阵列、磁盘高速缓冲
- 通用性
	- 统一方式处理所有I/O设备
	- 底层例程隐藏设备I/O的大部分细节，向进程和高层提供使用设备的通用方式（read、write、open、close、lock、unlock）
## OS设计层次（PPT 21）

## 假脱机技术SPOOLing（程序中介）

## 逻辑I/O与设备I/O
- 逻辑I/O：与设备无关的I/O软件
- 设备I/O：逻辑设备与物理设备间的过渡协调机构

## 设备驱动程序工作过程

## I/O缓冲

\#\## 
- 缓冲原因：
	- 进程必须等待I/O操作完成才能继续（执行速度慢）
	- 执行I/O期间一些页面必须保留在主存（干扰了OS的交换决策）
- 缓冲技术可提高外设利用率，尽可能使外设处于忙状态
- 限制：进程的I/O请求不能超过外设的处理能力
- 缓冲区位置：内存、控制器或外设——多级缓冲机制

### 缓冲设备
- 面向块的设备
	- 信息保存在固定大小的块中
	- 传送必须以块为单位
	- 磁盘、固态硬盘等
- 面向流的设备
	- 信息以字节流传送
	- 举例：终端、打印机、通信端口、鼠标等

### 缓冲方式（PPT 34）
- 单方向缓冲
	- 单缓冲
	- 双缓冲
	- 环形缓冲
- 双方向缓冲
	- 缓冲池

## 磁盘调度
- 磁盘的物理结构：盘面、磁头
- 盘面、柱面、磁道、扇区
- 500g以下的硬盘都是单盘片

### 磁盘调度
- 联想：虚拟存储调度、处理器调度
- 寻道时间是影响磁盘性能最主要的因素
- 当一个磁盘有多个I/O请求时，可按照一定的调度算法对这些请求的服务顺序进行调整，以减少平均寻道时间，同时也要遵循“公平”的原则。

#### 磁盘调度算法
1. 先进先出
2. 优先级
	- 目标并不在于优化磁盘效率而是满足操作系统的其他目的
	- 短的批作业可能具有较高优先级，从而提供较小的交互影响时间
	- 长作业可能要等待过长时间
3. 后进先出
	- 设备被分配给最近的使用者，因此移臂幅度可能非常小（局部性原理）
4. 最短服务时间优先（SSTF）
	- 优先选择距离当前磁头最近的访问请求进行服务（寻道优先）
	- 改善了磁盘平均服务时间，但是可能某些访问请求长期等待得不到服务
5. 电梯算法/扫描算法（SCAN）
	- 类似坐电梯...
	- 优点：克服了SSTF的缺点
	- 缺点：偏爱靠内/外道服务
6. 单向扫描算法（C-SCAN）
	- 从最低编号请求开始，处理到最高编号请求。
7. N步扫描算法（N-step-SCAN）
	- 将磁盘请求队列分成若干个长度为N的自队列
	- 每一次SCAN处理一个子队列
	- 新来的请求必须加入到没在处理的自队列中
	- 克服了SCAN偏爱最近作业的缺点

##### 寻道时间计算
- 磁头移动总距离/请求个数

## RAID
- RAID（独立/廉价磁盘冗余阵列），7个级别
- 特点
	1. 把多个物理磁盘组织在一起，作为一个逻辑驱动器-\>提供磁盘跨越功能
	2. 数据分成多个数据块，分布在阵列的各个物理磁盘上-\>可以并行写入/读出多个磁盘，提高访问磁盘的速度
	3. 利用磁盘冗余可进行镜像或校验操作等

### RAID0
- 逻辑盘的数据被分散分布
- 并行读写
- 没有冗余，没有备份
### RAID1
- 把一个磁盘的数据镜像到另一个磁盘上
- 两个盘上实施，数据冗余，数据安全性好
- 磁盘利用率低（50%）

### RAID2
- 并行读写：所有磁盘参与每一次I/O请求，所有磁头任何时刻都处于同一位置
- 汉明码进行纠错（一位纠错，两位检验），实现冗余，从而需要的磁盘数少于RAID1
- 缺点：仅用于错误率高的环境中。

### RAID3
- 只采用一个冗余磁盘存储校验数据
- 校验公式P(b) = b0异或b1异或b2异或b3
### RAID4
- 独立读写
- 每个磁盘的存取各自独立进行，从而可以同时处多个I/O请求
- 
### RAID5
- 类似RAID4，但是校验数据分布在各个磁盘上
- 避免RAID4出现的瓶颈——校验磁盘，提高整个校验磁盘的I/O总数

### RAID6
- 采用两种不同的数据校验算法
- 可以处理两个磁盘出错的情形
- 数据可靠性高
- 写性能损失严重

## 磁盘高速缓存
- 在内存中开辟一小块，用于存储磁盘中某些扇区的内容。